"Content"
"    diff --git a/crypto/mem_clr.c b/crypto/mem_clr.c&#xD;&#xA;    index e6450a1..3389919 100644 (file)&#xD;&#xA;    --- a/crypto/mem_clr.c&#xD;&#xA;    +++ b/crypto/mem_clr.c&#xD;&#xA;    @@ -59,23 +59,16 @@&#xD;&#xA;     #include <string.h>&#xD;&#xA;     #include <openssl/crypto.h>&#xD;&#xA;     &#xD;&#xA;    -extern unsigned char cleanse_ctr;&#xD;&#xA;    -unsigned char cleanse_ctr = 0;&#xD;&#xA;    +/*&#xD;&#xA;    + * Pointer to memset is volatile so that compiler must de-reference&#xD;&#xA;    + * the pointer and can't assume that it points to any function in&#xD;&#xA;    + * particular (such as memset, which it then might further """"""""optimize"""""""")&#xD;&#xA;    + */&#xD;&#xA;    +typedef void *(*memset_t)(void *,int,size_t);&#xD;&#xA;    +&#xD;&#xA;    +static volatile memset_t memset_func = memset;&#xD;&#xA;     &#xD;&#xA;     void OPENSSL_cleanse(void *ptr, size_t len)&#xD;&#xA;     {&#xD;&#xA;    -    unsigned char *p = ptr;&#xD;&#xA;    -    size_t loop = len, ctr = cleanse_ctr;&#xD;&#xA;    -&#xD;&#xA;    -    if (ptr == NULL)&#xD;&#xA;    -        return;&#xD;&#xA;    -&#xD;&#xA;    -    while (loop--) {&#xD;&#xA;    -        *(p++) = (unsigned char)ctr;&#xD;&#xA;    -        ctr += (17 + ((size_t)p & 0xF));&#xD;&#xA;    -    }&#xD;&#xA;    -    p = memchr(ptr, (unsigned char)ctr, len);&#xD;&#xA;    -    if (p)&#xD;&#xA;    -        ctr += (63 + (size_t)p);&#xD;&#xA;    -    cleanse_ctr = (unsigned char)ctr;&#xD;&#xA;    +    memset_func(ptr, 0, len);&#xD;&#xA;     }"
